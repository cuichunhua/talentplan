﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿# 1.部署环境## 1.1 node```共使用 4 台物理服务器- node1 tidb * 1    prometheus * 1   grafana * 1- node2 pd * 1    tikv * 1- node3 pd * 1    tikv * 1- node4 pd * 1    tikv * 1```## 1.2 硬件配置```cpu：  E5-2620v3 *2   40 vcoresmemory：  8*16Gdisk： 8* 480G SSD(RAID 50)```## 1.3 配置```v4.0.0tidb 配置alter-primary-key = falsecompatible-kill-query = falseenable-streaming = falsehost = "0.0.0.0"lease = "45s"lower-case-table-names = 2oom-action = "log"run-ddl = trueserver-version = ""socket = ""split-table = truestore = "tikv"token-limit = 1000skip-grant-table=true[binlog]ignore-error = falsewrite-timeout = "15s"[experimental]allow-auto-random = false[log]disable-timestamp = falseexpensive-threshold = 10000format = "text"level = "info"query-log-max-len = 2048slow-threshold = 300[log.file]max-backups = 0max-days = 0max-size = 300[opentracing]enable = falserpc-metrics = false[opentracing.reporter]buffer-flush-interval = 0local-agent-host-port = ""log-spans = falsequeue-size = 0[opentracing.sampler]max-operations = 0param = 1.0sampling-refresh-interval = 0sampling-server-url = ""type = "const"[performance]cross-join = truefeedback-probability = 0.05force-priority = "NO_PRIORITY"max-procs = 0pseudo-estimate-ratio = 0.8query-feedback-limit = 1024run-auto-analyze = truestats-lease = "3s"stmt-count-limit = 5000tcp-keep-alive = true[pessimistic-txn]enable = truemax-retry-count = 256[prepared-plan-cache]capacity = 100enabled = falsememory-guard-ratio = 0.1[proxy-protocol]header-timeout = 5networks = ""[security]cluster-ssl-ca = ""cluster-ssl-cert = ""cluster-ssl-key = ""ssl-ca = ""ssl-cert = ""ssl-key = ""[status]report-status = true[tikv-client]commit-timeout = "41s"grpc-connection-count = 16grpc-keepalive-time = 10grpc-keepalive-timeout = 3[txn-local-latches]capacity = 2048000enabled = falsetikv 配置[coprocessor][gc][import][metric][pd][pessimistic-txn][raftdb][raftdb.defaultcf][raftstore]raftdb-path = ""sync-log = true[readpool][readpool.coprocessor][readpool.storage][rocksdb]wal-dir = ""[rocksdb.defaultcf][rocksdb.defaultcf.titan][rocksdb.lockcf][rocksdb.titan][rocksdb.writecf][security]ca-path = ""cert-path = ""key-path = ""[server][server.labels][storage][storage.block-cache]```# 2. 压测## 2.1  sysbench- Point select 测试   ```time:300ssysbench --config-file=./bm_config_run oltp_point_select --threads=128 --tables=32 --table-size=10000000 runsysbench --config-file=./bm_config_run oltp_point_select --threads=512 --tables=32 --table-size=10000000 runsysbench --config-file=./bm_config_run oltp_point_select --threads=1024 --tables=32 --table-size=10000000 run```threads|tps|qps|min latency|avg latency|95th latency|max latency--|:--:|:--:|:--:|:--|:--:|--:128|117136|117136|0.22|1.09|2.91|43.06512|124807|124807|0.23|4.10|10.46|48.681024|125858|125858|0.30|8.13|21.11|93.39- update index 测试   ```time:300ssysbench --config-file=./bm_config_run oltp_update_index --threads=128 --tables=32 --table-size=10000000 runsysbench --config-file=./bm_config_run oltp_update_index --threads=512 --tables=32 --table-size=10000000 runsysbench --config-file=./bm_config_run oltp_update_index --threads=1024 --tables=32 --table-size=10000000 run```threads|tps|qps|min latency|avg latency|95th latency|max latency--|:--:|:--:|:--:|:--|:--:|--:128|12643|12643|0.39|10.12|16.12|216.08512|16852|16852|0.42|30.37|51.02|444.731024|19429|19429|0.74|52.68|90.78|326.71- read write 测试   ```time:300ssysbench --config-file=./bm_config_run oltp_read_write --threads=128 --tables=32 --table-size=10000000 runsysbench --config-file=./bm_config_run oltp_read_write --threads=512 --tables=32 --table-size=10000000 run```threads|tps|qps|min latency|avg latency|95th latency|max latency--|:--:|:--:|:--:|:--|:--:|--:128|2448|48963|14.51|52.26|73.13|417.15512|2469|49384|28.14|207.03|297.92|569.64## 2.2  go-ycsb- workloada ``` Update heavy workload: mix of 50/50 reads and writesgo-ycsb load mysql -P workloads/workloada -p recordcount=10000000 -p mysql.host=127.0.0.1 -p mysql.port=4000 --threads 256go-ycsb run mysql -P workloads/workloada -p operationcount=10000000 -p mysql.host=127.0.0.1 -p mysql.port=4000 --threads 256```- workloadb```Read mostly workload: Read/update ratio: 95/5```- workloadc``` Read only: Read/update ratio: 100/0```- workloadd``` Read latest workload: Read/update/insert ratio: 95/0/5```- workloade``` Short ranges: Scan/insert ratio: 95/5```- workloadf``` Read-modify-write workload: Read/read-modify-write ratio: 50/50```*latency: us*type|threads|ops|min latency|avg latency|99th latency|99.9th latency|99.99th latency|max latency--|:--|:--:|:--:|:--:|:--|:--:|:--:|:--:|--:workloada-Read|256|15832|561|1978 |10000|27000|41000|491061workloada-Upd|256|15832|1917|13933|191000|228000|387000|1156935b-Read|256|54051|546|4264|18000|29000|42000|54044b-Upd|256|2838|1960|8347|27000|184000|216000|399257f-Read|256|28294|552|2183|11000|20000|41000|207908f-READ_MODIFY_WRITE|256|14149|2543|15662|191000|228000|383000|1045644f-Upd|256|14149|1874|13454|189000|225000|381000|1044423## 2.3  go-tpc```go-tpc tpcc -H 127.0.0.1 -P 4000 -D tpcc --warehouses 100 prepare```